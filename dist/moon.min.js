/*
* Moon v0.2.1
* Copyright 2016-2017, Kabir Shah
* https://github.com/KingPixil/moon/
* Free to use under the MIT license.
* https://kingpixil.github.io/license
*/
!function(e,t){"object"==typeof module&&module.exports?module.exports=t():e.Moon=t()}(this,function(){"use strict";function e(e){this.$opts=e||{},this.$id=i++,this.$name=this.$opts.name||"root",this.$parent=this.$opts.parent||null,this.$data=this.$opts.data||{},this.$render=this.$opts.render||x,this.$hooks=this.$opts.hooks||{},this.$methods=this.$opts.methods||{},this.$events={},this.$dom={},this.$destroyed=!1,this.$initialRender=!0,this.$queued=!1,this.init()}var t={},n={},r={},i=0,o=function(t){e.config.silent||console.log(t)},s=function(e){console.error("[Moon] ERR: "+e)},u=function(e){var t={};if(!e.attributes)return t;for(var n=e.attributes,r=0;r<n.length;r++)t[n[r].name]=n[r].value;return t},a=function(){return{shouldRender:!0,component:!1,eventListeners:{}}},c=function(e){var t=/\n/g,n=/"/g;return e.replace(t,"\\n").replace(n,'\\"')},p=function(e,t,n){var r=/{{([A-Za-z0-9_]+)([A-Za-z0-9_.()\[\]]+)?}}/gi,i=e;return e.replace(r,function(e,r,o){o||(o=""),i=n?n(i,e,r,o):t?i.replace(e,'" + instance.get("'+r+'")'+o+' + "'):i.replace(e,'instance.get("'+r+'")'+o)}),i},f=function(e,t,n,r,i){return{type:e,val:t,props:n,children:r,meta:i||a()}},h=function(e){for(var t=[],n=0;n<e.length;n++){var r=e[n];Array.isArray(r)?t=t.concat(h(r)):"string"==typeof r||null===r?t.push(f("#text",r||"",{},[],a())):t.push(r)}return t},l=function(){var e=Array.prototype.slice.call(arguments),t=e.shift(),n=e.shift()||{},r=e.shift(),i=h(e);return f(t,i.join(""),n,i,r)},v=function(e,t,n){var r=t.meta.eventListeners;for(var i in r)for(var o=0;o<r[i].length;o++){var s=r[i][o];n.$events[i]?n.on(i,s):e.addEventListener(i,s)}},d=function(e,t){var n;if("#text"===e.type)n=document.createTextNode(e.val);else{n=document.createElement(e.type);for(var r=e.children.map(function(e){return d(e,t)}),i=0;i<r.length;i++)n.appendChild(r[i]);v(n,e,t)}return m(n,{},e.props,e),n},m=function(e,r,i,o){var s=g(r,i);for(var u in s)!i[u]||t[u]||n[u]?(t[u]&&t[u](e,s[u],o),e.removeAttribute(u)):r[u]&&r[u]===i[u]||e.setAttribute(u,i[u])},y=function(t,n,r,i){var o;if(t&&(o=t.nodeName.toLowerCase()),n&&n.meta.shouldRender)if(t)if(n){if(o!==n.type)r.replaceChild(d(n,i),t);else if("#text"===o&&"#text"===n.type)t.textContent=n.val;else if(n.type){var s=u(t);m(t,s,n.props,n),i.$initialRender&&v(t,n,i);for(var a=0;a<n.children.length||a<t.childNodes.length;a++)y(t.childNodes[a],n.children[a],t,i)}}else r.removeChild(t);else r.appendChild(d(n,i));else n&&!n.meta.shouldRender&&n.props[e.config.prefix+"pre"]&&t.removeAttribute(e.config.prefix+"pre")},$=function(e,t){for(var n in t)e[n]=t[n];return e},g=function(e,t){var n={};for(var r in e)n[r]=e[r];for(var r in t)n[r]=t[r];return n},k=function(e,t){var n=e.$hooks[t];n&&n()},x=function(){},b=function(e,t){var n={input:e,current:0,tokens:[]};return A(n),n.tokens},A=function(e){for(var t=e.input,n=t.length;e.current<n;)"<"===t.charAt(e.current)?"<!--"!==t.substr(e.current,4)?G(e):R(e):L(e)},L=function(e){var t=e.input,n=t.length,r=t.indexOf("<",e.current);return r===-1?(e.tokens.push({type:"text",value:t.slice(e.current)}),void(e.current=n)):void(r!==e.current&&(e.tokens.push({type:"text",value:t.slice(e.current,r)}),e.current=r))},R=function(e){var t=e.input,n=t.length;e.current+=4;var r=t.indexOf("-->",e.current);return r===-1?(e.tokens.push({type:"comment",value:t.slice(e.current)}),void(e.current=n)):(e.tokens.push({type:"comment",value:t.slice(e.current,r)}),void(e.current=r+3))},G=function(e){var t=e.input,n=(t.length,"/"===t.charAt(e.current+1));t.charAt(e.current);e.tokens.push({type:"tagStart",close:n}),e.current+=n?2:1;var r=O(e);C(e);var i="/"===t.charAt(e.current);e.tokens.push({type:"tagEnd",close:!1}),e.current+=i?2:1,i&&(e.tokens.push({type:"tagStart",close:!0}),e.tokens.push({type:"tag",value:r}),e.tokens.push({type:"attribute",value:{}}),e.tokens.push({type:"tagEnd",close:!1}))},O=function(e){for(var t=e.input,n=t.length,r=e.current;r<n;){var i=t.charAt(r);if("/"!==i&&">"!==i&&" "!==i)break;r++}for(var o=r;o<n;){var i=t.charAt(o);if("/"===i||">"===i||" "===i)break;o++}var s=t.slice(r,o);return e.tokens.push({type:"tag",value:s}),e.current=o,s},C=function(e){for(var t=e.input,n=t.length,r=e.current,i={},o="",s=/([^=\s]*)(=?)("[^"]*"|[^\s"]*)/gi;r<n;){var u=t.charAt(r);if(">"===u||"/"===u)break;o+=u,r++}o.replace(s,function(e,t,n,r){var o=r[0],s=r[r.length-1];("'"===o&&"'"===s||'"'===o&&'"'===s)&&(r=r.slice(1,-1)),r||(r=t),t&&r&&(i[t]=r)}),e.current=r,e.tokens.push({type:"attribute",value:i})},E=function(e){for(var t={type:"ROOT",children:[]},n={current:0,tokens:e};n.current<e.length;){var r=T(n);r&&t.children.push(r)}return t},S=function(e,t,n){return{type:e,props:t,children:n}},T=function(e){var t=e.tokens[e.current],n=e.tokens[e.current-1],r=e.tokens[e.current+1],i=e.tokens[e.current+2],o=e.tokens[e.current+3],s=function(o){e.current+=void 0===o?1:o,t=e.tokens[e.current],n=e.tokens[e.current-1],r=e.tokens[e.current+1],i=e.tokens[e.current+2]};if("text"===t.type)return s(),n.value;if("comment"===t.type)return void s();if("tagStart"===t.type&&!t.close&&!o.close){var u=S(r.value,i.value,[]);r.value;s(4);var a=e.current;if(t){for(;"tagStart"!==t.type||"tagStart"===t.type&&!t.close;){var c=T(e);if(c&&u.children.push(c),s(0),!t){e.current=a-1;break}}s()}return u}s()},j=function(e){var t=e.props;if(0===Object.keys(t).length)return"{}";var r="{";for(var i in t)n[i]&&n[i].beforeGenerate&&n[i].beforeGenerate(t[i],e),r+='"'+i+'": '+p(JSON.stringify(t[i]),!0)+", ";return r=r.slice(0,-2)+"}"},M=function(e){if(0===Object.keys(e).length)return"{}";var t="{";for(var n in e)t+='"'+n+'": ['+_(e[n])+"], ";return t=t.slice(0,-2)+"}"},N=function(e){var t="{";for(var n in e)t+="eventListeners"===n?'"'+n+'": '+M(e[n])+", ":'"'+n+'": '+e[n]+", ";return t=t.slice(0,-2)+"}"},_=function(e){for(var t="",n=0;n<e.length;n++)t+=e[n]+", ";return t=t.slice(0,-2)},q=function(e,t){var n='h("'+e.type+'", ';return n+=j(e)+", ",n+=N(e.meta)+", ",n+=t.length?_(t):'""',n+=")"},w=function(e){var t="";if("string"==typeof e)t+='"'+p(c(e),!0)+'"';else{var r=e.children.map(w);e.meta||(e.meta=a());var i=q(e,r);for(var o in e.props)n[o]&&n[o].afterGenerate&&(i=n[o].afterGenerate(e.props[o],i,e));t+=i}return t},K=function(e){var t=e.children[0],n="var instance = this; return "+w(t);try{return new Function("h",n)}catch(e){return s("Could not create render function"),x}},z=function(e){var t=b(e),n=E(t);return K(n)};return e.prototype.get=function(e){return this.$data[e]},e.prototype.set=function(e,t){var n=this;this.$data[e]=t,this.$queued||this.$destroyed||(this.$queued=!0,setTimeout(function(){n.build(),k(n,"updated"),n.$queued=!1},0))},e.prototype.destroy=function(){this.removeEvents(),this.$destroyed=!0,k(this,"destroyed")},e.prototype.callMethod=function(e,t){t=t||[],this.$methods[e].apply(this,t)},e.prototype.on=function(e,t){this.$events[e]?this.$events[e].push(t):this.$events[e]=[t]},e.prototype.off=function(e,t){var n=this.$events[e].indexOf(t);n!==-1&&this.$events[e].splice(n,1)},e.prototype.removeEvents=function(){for(var e in this.$events)this.$events[e]=[]},e.prototype.emit=function(e,t){if(t=t||{},t.type=e,this.$events["*"])for(var n=0;n<this.$events["*"].length;n++){var r=this.$events["*"][n];r(t)}for(var n=0;n<this.$events[e].length;n++){var i=this.$events[e][n];i(t)}},e.prototype.renderLoop=function(e,t){for(var n=[],r=0;r<e.length;r++)n.push(t(e[r],r));return n},e.prototype.mount=function(t){this.$el=document.querySelector(t),this.$destroyed=!1,this.$el||s("Element "+this.$opts.el+" not found"),this.$el.__moon__=this,this.$template=this.$opts.template||this.$el.outerHTML,this.$render===x&&(this.$render=e.compile(this.$template)),this.build(),k(this,"mounted")},e.prototype.render=function(){return this.$render(l)},e.prototype.patch=function(e,t,n){y(e,t,n,this),this.$initialRender=!1},e.prototype.build=function(){this.$dom=this.render(),this.patch(this.$el,this.$dom,this.$el.parentNode)},e.prototype.init=function(){o("======= Moon ======="),k(this,"created"),this.$opts.el&&this.mount(this.$opts.el)},e.config={silent:!1,prefix:"m-",keyCodes:{}},e.version="0.2.1",e.util={noop:x,error:s,log:o,merge:g,extend:$},e.use=function(t){t.init(e)},e.compile=function(e){return z(e)},e.nextTick=function(e){setTimeout(e,0)},e.directive=function(n,r){t[e.config.prefix+n]=r},e.component=function(t,n){function i(){e.call(this,n)}var o=this;return n.name=t,n.parent=parent,i.prototype=Object.create(o.prototype),i.prototype.constructor=i,i.prototype.init=function(){k(this,"created"),this.$destroyed=!1,this.$props=this.$opts.props||[],this.$template=this.$opts.template,this.$render===x&&(this.$render=e.compile(this.$template))},r[t]=i,i},n[e.config.prefix+"if"]={afterGenerate:function(e,t,n){return"("+p(e,!1)+") ? "+t+" : ''"}},n[e.config.prefix+"for"]={afterGenerate:function(e,t,n){var r=e.split(" in "),i=r[0].split(","),o='instance.get("'+r[1]+'")',s=i.join(","),u=function(e,t,n,r){return i.indexOf(n)===-1?e:e.replace(t,'" + '+n+r+' + "')};return"instance.renderLoop("+o+", function("+s+") { return "+p(t,!0,u)+"; })"}},n[e.config.prefix+"on"]={beforeGenerate:function(e,t){var n={stop:"event.stopPropagation();",prevent:"event.preventDefault();",ctrl:"if(!event.ctrlKey) {return;};",shift:"if(!event.shiftKey) {return;};",alt:"if(!event.altKey) {return;};"},r=e.split(":"),i=r[0].split("."),o=i[0],s=r[1],u="(event)",a=s.split("(")[1];a&&(u="");var c="";i.shift();for(var p=0;p<i.length;p++)c+=n[i[p]];var f="function(event) {"+c+"instance.$methods."+s+u+"}";t.meta.eventListeners[o]?t.meta.eventListeners[o].push(f):t.meta.eventListeners[o]=[f]}},n[e.config.prefix+"model"]={beforeGenerate:function(e,t){var n='function(event) {instance.set("'+e+'", event.target.value)}';t.meta.eventListeners.input?t.meta.eventListeners.input.push(n):t.meta.eventListeners.input=[n]}},n[e.config.prefix+"once"]={beforeGenerate:function(e,t){t.meta.shouldRender="instance.$initialRender"}},n[e.config.prefix+"pre"]={beforeGenerate:function(e,t){t.meta.shouldRender=!1}},t[e.config.prefix+"show"]=function(e,t,n){var r=new Function("return "+t);r()?e.style.display="block":e.style.display="none"},t[e.config.prefix+"text"]=function(e,t,n){e.textContent=t;for(var r=0;r<n.children.length;r++)n.children[r].meta.shouldRender=!1},t[e.config.prefix+"html"]=function(e,t,n){e.innerHTML=t;for(var r=0;r<n.children.length;r++)n.children[r].meta.shouldRender=!1},t[e.config.prefix+"mask"]=function(e,t,n){},e});